---
title: "Home care hours"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_knit$set(root.dir = 'C:/GitHub/social_care_open_data')
Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.21") #For font recognition
```

#Intro

Quick plot of home care hours for 2012

##Load data

Load 2011 data - object `soc_care11` was created in "reports/import_and_tidy.html"

```{r load_data}
load("produced_data/created_objects/soc_care12.rds")
```

##Load packages

```{r packages, message=FALSE, warning=FALSE}
library(dplyr)
library(forcats)
library(ggplot2)
library(ggthemes)
library(ggsci)
library(cowplot)
library(extrafont)
```

#Plot

1st of all collapse the total_hrs variable into smaller factor levels.

Currently <1, 1-2, 2-4, 4-6, 6-8, 8-10, 10-15, 15-20, 20-30, 30-40, and over 50.

I'll collapse these levels to <4, 4-10, 10-15, and over 20

```{r fct_collapse}
soc_care12$total_hrs <- 
  fct_collapse(soc_care12$total_hrs, 
               `<4` = c("<1", "1-2", "2-4"),
               `4-10` = c("4-6", "6-8", "8-10"), #10-15 stays as is
               over20 = c("20-30", "30-40", "40-50", "over50"))
```

Now summarise the data

```{r summarise_home_care_hrs}

home_care_hrs <-
  soc_care12 %>%
  filter(hc_client == "Yes") %>%      #keep only home care clients
  filter(age_grp != "18-<65") %>%     #keep only those over 65
  filter(council != "Highland") %>%   #remove highland due to missing data
  group_by(council, total_hrs) %>%
  summarize(N = n()) %>%
  mutate(freq = N / sum(N),
         pct = round((freq*100), 1)) 

home_care_hrs
  
```


Now plot, to help ordering the bars I'm going to create a vector with the Local Authorities ordered by those with highest ratios of clients receiving <4 hrs of home care. This vector can then be dropped into the ggplot to arrange the data as needed. 

```{r order}
ordered <-                   #Create a vector with LAs ordered by <4hrs 
  home_care_hrs %>%
  filter(total_hrs == "<4") %>%
  arrange(-pct)

ordered_LAs <- ordered$council

```


Finally, time to plot

```{r plot, fig.height=16,fig.width=10}
hmcare_plot <- 
  ggplot(home_care_hrs, 
            aes(
              x = reorder(council, pct), 
              y = freq,   #I'll use scales::percent below
              fill = total_hrs)) + 
  geom_bar(position = "dodge", stat = "identity") +
  labs(x = "Local Authority",
       y = "Percent", 
       fill = "total_hrs",
       title = "Home Care Hours",
       subtitle = "2012 Social Care Survey") +
  theme_hc() +
  scale_y_continuous(labels = scales::percent) + #Using freq instead of percent variable
  scale_x_discrete(limits = ordered_LAs) +   #using above vector
  theme(legend.position = "right") +
  scale_fill_aaas() +
  coord_flip()

hmcare_plot
```

Still a bit noisy, I'll try plotting <4 hrs only

```{r less_than_four_plot, fig.height=10, fig.width=10}
less_than_four_plot <- 
  home_care_hrs %>%
  filter(total_hrs == "<4") %>%
  ggplot(.,
         aes(
              x = reorder(council, -pct), 
              y = freq  #I'll use scales::percent below
              )) +   
  geom_col(fill = "blue4") +
  labs(x = "",
       y = "", 
       title = "Proportion of clients receiving less than 4 hrs home care",
       subtitle = "2012 Social Care Survey") +
  theme_hc() +
  scale_y_continuous(labels = scales::percent) + #Using freq instead of percent variable
  theme(legend.position = "none") +
  coord_flip()

less_than_four_plot
```

```{r four_to_ten_plot, fig.height=10, fig.width=10}
four_to_ten_plot <- 
  home_care_hrs %>%
  filter(total_hrs == "4-10") %>%
  ggplot(.,
         aes(
              x = reorder(council, -pct), 
              y = freq  #I'll use scales::percent below
              )) +   
  geom_col(fill = "chartreuse4") +
  labs(x = "",
       y = "", 
       title = "Proportion of clients receiving between 4 and 10hrs home care",
       subtitle = "2012 Social Care Survey") +
  theme_hc() +
  scale_y_continuous(labels = scales::percent) + #Using freq instead of percent variable
  theme(legend.position = "none") +
  coord_flip()

four_to_ten_plot
```


Plot side-by-side

```{r cowplot, fig.width=12, fig.height=12}
plot_grid(less_than_four_plot, four_to_ten_plot, labels = c("Title"))
```


Actually, a facet plot will be much better...


```{r facet, fig.height=10, fig.width=10}
home_care_facet <- 
  ggplot(home_care_hrs, 
         aes(
           x = council,
           y = freq,   #I'll use scales::percent below
           fill = total_hrs)) + 
  geom_col() +
  geom_hline(yintercept = c(0.2, 0.4, 0.6), alpha = 0.1) +
  facet_wrap(~total_hrs, ncol = 5) +
  scale_x_discrete(limits = ordered_LAs) +
  scale_y_continuous(labels = scales::percent) + #Using freq instead of percent variable
  labs(x = "",
       y = "", 
       fill = "Total hours of home care per week",
       title = "Figure 2. Percentage of Local Authority clients over 65 receiving specified hours of home care", #Figure 2 for UBDC blog only!
       subtitle = "Ranked by proportion receiving less than 4 hours of care",
       caption = "2012 Social Care Survey, Highland council removed due large amount of missing data") +
  theme_minimal(base_size = 12, base_family = "Roboto") +
  theme(legend.position = "bottom",
        plot.subtitle = element_text(color="#666666"),
        plot.title = element_text(family="Roboto Condensed", face = "bold"),
        plot.caption = element_text(color="#AAAAAA", size=10),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10, face = "bold"),
        strip.text.x = element_text(size = 12, face = "bold")) +
  scale_fill_lancet() +
  coord_flip()

home_care_facet

```

Save for UBDC blog

```{r save_plot, eval = FALSE}
ggsave("plots/homecare_facet.png", home_care_facet, width=10, height=10)
```

Try a clevland dotplot

```{r clevland, fig.height = 10, fig.width=10}
home_care_facet_clevland <- 
  ggplot(home_care_hrs, 
         aes(
           x = council,
           y = freq,   #I'll use scales::percent below
           color = total_hrs)) + 
  geom_point(size = 3) +
  facet_wrap(~total_hrs, ncol = 5) +
  scale_x_discrete(limits = ordered_LAs) +
  scale_y_continuous(labels = scales::percent) + #Using freq instead of percent variable
  labs(x = "",
       y = "", 
       fill = "Total hours of home care per week",
       title = "Figure 2. Percentage of Local Authority clients over 65 receiving specified hours of home care", #Figure 2 for UBDC blog only!
       subtitle = "Ranked by proportion receiving less than 4 hours of care",
       caption = "2012 Social Care Survey, Highland council removed due large amount of missing data")  +
  coord_flip() +
  theme(text = element_text(size = 12, family = "Roboto"),
        legend.position = "none",
        plot.subtitle = element_text(color="#666666", size = 10),
        plot.title = element_text(family="Roboto Condensed", face = "bold", hjust = 0),
        plot.caption = element_text(color="#AAAAAA", size=10),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10, face = "bold"),
        strip.text.x = element_text(size = 12, face = "bold")) +
  scale_color_lancet()

home_care_facet_clevland
````


```{r}
ggsave("plots/homecare_facet_clevland.png", home_care_facet_clevland, width=10, height=10)
```







   +
  coord_flip()

home_care_facet
```